<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‚æ•°åŒ– 3D æ¨¡å‹ç”Ÿæˆå™¨</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background-color: #f0f0f0; }
        canvas { display: block; }
        
        /* UI é¢æ¿æ ·å¼ */
        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            width: 280px;
        }
        
        h2 { margin-top: 0; font-size: 18px; color: #333; }
        
        .control-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; color: #555; }
        input[type="number"], select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            border: none;
            color: white;
            padding: 12px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        #btn-regenerate {
            background-color: #4CAF50; /* Green */
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 16px;
        }
        #btn-regenerate:hover { background-color: #45a049; }

        #btn-screenshot {
            background-color: #008CBA; /* Blue */
            position: absolute;
            bottom: 20px;
            left: 20px;
        }
        #btn-screenshot:hover { background-color: #007bb5; }

        /* æç¤ºä¿¡æ¯ */
        #message {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            display: none;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="controls">
        <h2>å‚æ•°è®¾ç½®</h2>
        
        <div class="control-group">
            <label for="lengthInput">1. é•¿åº¦ (10 - 50)</label>
            <input type="number" id="lengthInput" value="20" min="10" max="50">
        </div>

        <div class="control-group">
            <label for="verticalAngle">2. ç«–å‘è§’åº¦</label>
            <select id="verticalAngle">
                <option value="up">a. ä¸Šç¿˜</option>
                <option value="straight" selected>b. å¹³ç›´</option>
                <option value="down">c. ä¸‹å¼¯</option>
            </select>
        </div>

        <div class="control-group">
            <label for="horizontalAngle">3. æ°´å¹³è§’åº¦</label>
            <select id="horizontalAngle">
                <option value="left">a. å·¦å¼¯</option>
                <option value="straight" selected>b. å¹³ç›´</option>
                <option value="right">c. å³å¼¯</option>
            </select>
        </div>

        <div class="control-group">
            <label for="detailLevel">4. ç²¾ç»†åŒ–ç¨‹åº¦</label>
            <select id="detailLevel">
                <option value="high">a. ç²¾ç»†</option>
                <option value="medium" selected>b. é€‚ä¸­</option>
                <option value="low">c. ç²—ç³™</option>
            </select>
        </div>
    </div>

    <button id="btn-screenshot" class="btn">ğŸ“· æˆªå›¾ä¿å­˜</button>
    <button id="btn-regenerate" class="btn">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>

    <div id="message">æˆªå›¾å·²ä¸‹è½½</div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // 1. åˆå§‹åŒ–åœºæ™¯
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xe0e0e0); // æµ…ç°èƒŒæ™¯

        // 2. åˆå§‹åŒ–ç›¸æœº
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(30, 30, 50);

        // 3. åˆå§‹åŒ–æ¸²æŸ“å™¨
        const renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true }); // preserveDrawingBuffer å…è®¸æˆªå›¾
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // 4. æ·»åŠ ç¯å…‰
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(10, 20, 10);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // 5. æ§åˆ¶å™¨ (å…è®¸ç”¨æˆ·æ—‹è½¬ã€ç¼©æ”¾)
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        
        // å…¨å±€å˜é‡å­˜å‚¨å½“å‰æ¨¡å‹ï¼Œä»¥ä¾¿ç§»é™¤
        let currentMesh = null;

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šç”Ÿæˆæ¨¡å‹ ---
        function generateModel() {
            // æ¸…é™¤æ—§æ¨¡å‹
            if (currentMesh) {
                scene.remove(currentMesh);
                currentMesh.geometry.dispose();
                currentMesh.material.dispose();
            }

            // è·å–ç”¨æˆ·è¾“å…¥
            const lengthVal = parseFloat(document.getElementById('lengthInput').value) || 20;
            const vAngle = document.getElementById('verticalAngle').value;
            const hAngle = document.getElementById('horizontalAngle').value;
            const detail = document.getElementById('detailLevel').value;

            // 1. è®¡ç®—å¼¯æ›²æ§åˆ¶ç‚¹ (ä½¿ç”¨ CatmullRomCurve3 æˆ– QuadraticBezierCurve3)
            // èµ·ç‚¹
            const startPoint = new THREE.Vector3(0, 0, 0);
            
            // ç»ˆç‚¹ (åŸºäºé•¿åº¦ï¼Œé»˜è®¤ä¸ºZè½´å»¶ä¼¸)
            let endX = 0;
            let endY = 0;
            let endZ = lengthVal;

            // æ§åˆ¶ç‚¹åç§» (æ¨¡æ‹Ÿå¼¯æ›²)
            let midX = 0;
            let midY = 0;
            const midZ = lengthVal / 2;

            // å¤„ç†ç«–å‘è§’åº¦
            const bendFactor = lengthVal * 0.4; // å¼¯æ›²å¼ºåº¦
            if (vAngle === 'up') {
                midY = bendFactor;
                endY = bendFactor * 0.5;
            } else if (vAngle === 'down') {
                midY = -bendFactor;
                endY = -bendFactor * 0.5;
            }

            // å¤„ç†æ°´å¹³è§’åº¦
            if (hAngle === 'left') {
                midX = bendFactor; // æ³¨æ„åæ ‡ç³»æ–¹å‘
                endX = bendFactor * 0.5;
            } else if (hAngle === 'right') {
                midX = -bendFactor;
                endX = -bendFactor * 0.5;
            }

            // åˆ›å»ºè·¯å¾„æ›²çº¿
            const curve = new THREE.QuadraticBezierCurve3(
                startPoint,
                new THREE.Vector3(midX, midY, midZ),
                new THREE.Vector3(endX, endY, endZ)
            );

            // 2. ç¡®å®šç²¾åº¦
            let tubularSegments = 20;
            let radialSegments = 8;

            if (detail === 'high') {
                tubularSegments = 100;
                radialSegments = 32;
            } else if (detail === 'medium') {
                tubularSegments = 50;
                radialSegments = 16;
            } else { // coarse
                tubularSegments = 10;
                radialSegments = 6;
            }

            // 3. åˆ›å»ºå‡ ä½•ä½“ (TubeGeometry æ²¿è·¯å¾„ç”Ÿæˆç®¡çŠ¶ä½“)
            const radius = 3; // é»˜è®¤åŠå¾„
            const geometry = new THREE.TubeGeometry(curve, tubularSegments, radius, radialSegments, false);

            // 4. åˆ›å»ºæè´¨
            const material = new THREE.MeshPhysicalMaterial({
                color: 0x3498db, // è“è‰²
                roughness: 0.5,
                metalness: 0.1,
                clearcoat: 0.3,
                side: THREE.DoubleSide
            });

            // 5. åˆ›å»ºç½‘æ ¼å¹¶æ·»åŠ åˆ°åœºæ™¯
            currentMesh = new THREE.Mesh(geometry, material);
            currentMesh.castShadow = true;
            currentMesh.receiveShadow = true;
            
            // è°ƒæ•´ä¸­å¿ƒç‚¹ï¼Œè®©æ¨¡å‹å±…ä¸­æ—‹è½¬
            geometry.center();
            
            scene.add(currentMesh);
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šæˆªå›¾ä¿å­˜ ---
        function takeScreenshot() {
            // é‡æ–°æ¸²æŸ“ä¸€å¸§ä»¥ç¡®ä¿æœ€æ–°çŠ¶æ€
            renderer.render(scene, camera);
            
            // è·å– Data URL
            const imgData = renderer.domElement.toDataURL("image/png");
            
            // åˆ›å»ºè™šæ‹Ÿé“¾æ¥ä¸‹è½½
            const link = document.createElement('a');
            link.download = `model_snapshot_${Date.now()}.png`;
            link.href = imgData;
            link.click();

            // æ˜¾ç¤ºæç¤º
            const msg = document.getElementById('message');
            msg.style.display = 'block';
            setTimeout(() => { msg.style.display = 'none'; }, 2000);
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('btn-regenerate').addEventListener('click', generateModel);
        document.getElementById('btn-screenshot').addEventListener('click', takeScreenshot);
        window.addEventListener('resize', onWindowResize, false);

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // åŠ¨ç”»å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        // åˆå§‹åŒ–ç”Ÿæˆ
        generateModel();
        animate();

    </script>
</body>
</html>